@{
    ViewData["Title"] = "Online IDE";
}

<div class="container">
    <h2>Online IDE</h2>
    <div class="row">
        <div class="col-md-8">
            <div id="editor" style="height: 400px; border: 1px solid grey;"></div>
        </div>
        <div class="col-md-4">
            <!-- Input fields for user input -->
            <div id="inputs-container"></div>
            <button id="runButton" class="btn btn-primary mb-3">Run Code</button>
            <div id="output" style="height: 350px; border: 1px solid grey; overflow-y: auto; padding: 10px;"></div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs' } });
        require(['vs/editor/editor.main'], function () {
            var editor = monaco.editor.create(document.getElementById('editor'), {
                value: '# Write your Python code here\nprint("Hello, World!")',
                language: 'python',
                theme: 'vs-dark'
            });

            // Function to dynamically add input fields based on the number of input() calls
            function generateInputFields() {
                var code = editor.getValue();
                const inputCount = (code.match(/input\(/g) || []).length; // Count occurrences of input()
                const inputsContainer = document.getElementById('inputs-container');
                inputsContainer.innerHTML = ''; // Clear existing inputs

                for (let i = 0; i < inputCount; i++) {
                    const inputField = document.createElement('input');
                    inputField.setAttribute('class', 'form-control mb-2');
                    inputField.setAttribute('placeholder', `Input ${i + 1}`);
                    inputField.setAttribute('id', `input${i}`); // Add unique ID for each input
                    inputsContainer.appendChild(inputField);
                }
            }

            // Add event listener for editor changes
            editor.onDidChangeModelContent(() => {
                generateInputFields(); // Update input fields when the code is changed
            });

            // Run code when the button is clicked
            document.getElementById('runButton').addEventListener('click', function () {
                var code = editor.getValue();
                var outputElement = document.getElementById('output');
                outputElement.innerText = 'Running code...';

                // Gather inputs from the input fields
                var inputs = [];
                const inputFields = document.querySelectorAll('#inputs-container input');
                inputFields.forEach((inputField) => {
                    inputs.push(inputField.value); // Collect the value from each input field
                });

                console.log('Sending code and inputs to server:', code, inputs);

                fetch('/OnlineIDE/RunCode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ code: code, inputs: inputs, language: 'python' }),
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Received data:', data);
                        if (data.success) {
                            console.log('Raw output:', data.output);

                            // Split the output into lines
                            var lines = data.output.split('\n');
                            console.log('Lines of output:', lines);

                            // Clean each line
                            var cleanLines = lines.map(line => line.replace(/^\s*[\u0000-\u001F\u007F-\u009F]+/, '').trim());
                            console.log('Cleaned lines:', cleanLines);

                            // Join the cleaned lines back together and update the output element
                            outputElement.innerText = cleanLines.join('\n'); // Join back with newlines
                        } else {
                            console.log('Error output:', data.output);
                            outputElement.innerText = 'Error: ' + data.output;
                        }
                        console.log('Output element text:', outputElement.innerText);
                    })
                    .catch((error) => {
                        console.error('Error:', error);
                        outputElement.innerText = 'An error occurred while running the code.';
                    });
            });


            // Initialize input fields when the page is loaded
            generateInputFields();
        });
    </script>
}
